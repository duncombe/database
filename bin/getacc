#! /bin/bash

# gets a newaccession number and writes it back to the file
# each accesssion number has a collection UUID
# generate it here

# getacc(){ 

# LOCKFILE=lock
LOCKFILE=${LOCKFILE:-/var/lock/amsaccession.lock}

if [ ! -e $LOCKFILE ]; then echo "No lockfile. Quitting."; exit 2; fi 

AMSACCFILE=${AMSACCFILE:-/DATA/amsaccession}
if [ ! -e $AMSACCFILE ]; then touch $AMSACCFILE; fi

TMPFILE=`mktemp`
(	flock 9
        # if the accession file is empty ie brand new then echo a line

        { [ -s $AMSACCFILE ] || echo ; tail -n1 $AMSACCFILE ;} |
		awk '{  cmd="uuidgen"
			cmd | getline UUID
			close(cmd)
			printf "%07d\t%s\n",$1+1,UUID
			}' > $TMPFILE
        cat $TMPFILE >> $AMSACCFILE
	) 9< $LOCKFILE

cat $TMPFILE 
rm -f $TMPFILE

#       }

