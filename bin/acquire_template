#! /bin/bash
# ingest template processor 
# defines the environmental variables that configure the ingest script 

# You can source  the database variables inside this script to avoid
# contaminating your shell, e.g., source publicdatabase.cfg
# using a database.cfg file simplifies changes you need to make below
# source database.cfg

# these are likely to need changing if you have to change anything
# export REVISION=${REVISION:-0}
# export PARENT=${PARENT}

# the source directory is defined by SOURCE_DIR
export SOURCE_DIR="${1:?Provide the source directory as the first argument }"

# COLLECTION is a pre-issued accession UUID for the dataset. If COLLECTION is
# empty, a new accession will be generated by make_catalog
export COLLECTION=${COLLECTION}
export COLLECTION_TITLE="${COLLECTION_TITLE:?Provide a title for collection (COLLECTION_TITLE)}"


########################################################
# these below may not need changing if you use the database.cfg file above
# 
# ensure source dir ends in a /
SOURCE_DIR=${SOURCE_DIR%/}/

# processing scripts are defined by INGEST_HOME
export INGEST_HOME=${INGEST_HOME:?INGEST_HOME defines directory holding processing scripts}

# dumping data into the database described by DATABASE, CATALOG, and LOGFILE
# can assign a variable DATABASE_DIR that allows easy assignment of the rest
# export DATABASE_DIR=/DATA/LOCALWEB/DATA
# export CATALOG=$DATABASE_DIR/manifest.txt
# etc
export CATALOG=${CATALOG:?CATALOG: the manifest file, e.g., "/DATA/LOCALWEB/DATA/manifest.txt"}
export DATABASE=${DATABASE:?DATABASE: the database directory, e.g., "/DATA/LOCALWEB/DATA/.DATABASE"}
export LOGFILE=${LOGFILE:?LOGFILE: the log file, e.g., "/DATA/LOCALWEB/DATA/ingest.log"}

# the accession reference and directory structure are defined by
# ACCESSION_DIR 
export ACCESSION_DIR=${ACCESSION_DIR:?The accession reference and directory structure, e.g., "/DATA/LOCALWEB/DATA/ACCESSION"}

export AMSACCFILE="${AMSACCFILE:?Get the next AMS accession number from this file (/DATA/amsaccession)}"

# 
# No further environmental variables to change beyond this point.
#################################################################

echo INGEST_HOME=${INGEST_HOME}
echo CATALOG=${CATALOG}
echo DATABASE=${DATABASE}
echo LOGFILE=${LOGFILE}
echo ACCESSION_DIR=${ACCESSION_DIR}
echo AMSACCFILE=${AMSACCFILE}
echo SOURCE_DIR=${SOURCE_DIR}
echo COLLECTION_TITLE=\"${COLLECTION_TITLE}\"
if [ "x$COLLECTION" != "x" ]; then  
	echo COLLECTION=${COLLECTION}
fi
echo Other variables that might be set: PARENT, REVISION
echo REVISION=${REVISION:-0}
echo PARENT=${PARENT}
echo 
# provide some information that may influence whether to proceed
echo "Space used in SOURCE_DIR="`du -hs "${SOURCE_DIR}" | awk '{print $1}'`
echo "Free space on ACCESSION_DIR="`df -h $ACCESSION_DIR  | tail -n1 | awk '{print $4}'`
echo 
echo Testing checksums: 
${INGEST_HOME}/test_checksums "${SOURCE_DIR}"
echo 
read -p "Environmental variables are loaded. Complete the ingest (y) or stop (N)? " RESP
RESP=${RESP^^} 
if [ "${RESP:0:1}" = "Y" ]; then
	$INGEST_HOME/ingest.sh "${SOURCE_DIR}"
else
	echo Abandoned processing
fi

# vi:se tw=0 :
